setwd("C:/Users/bgillis/Desktop")
files <- list.files("C:/Users/bgillis/Desktop/CSVs provided by Agencies")
dir <- "C:/Users/bgillis/Desktop/CSVs provided by Agencies"
files <- list.files(dir)
# Run the loop
x0 <- data.frame()
for (f in seq_along(files)) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
source("loading the client level data function.R")
getwd()
setwd("C:/Users/bgillis/Documents/GitHub")
list.files()
loading-sep2017-reporting
setwd("C:/Users/bgillis/Documents/GitHub/loading-sep2017-reporting")
library(RODBC)
library(reshape2)
library(dplyr)
setwd("C:/Users/bgillis/Documents/GitHub/loading-sep2017-reporting")
source("loading the client level data function.R")
x0 <- data.frame()
for (f in seq_along(files)) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
library(readr)
for (f in seq_along(files)) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
for (f in files) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
dir <- "C:/Users/bgillis/Desktop/CSVs provided by Agencies/"
files <- list.files(dir)
# Run the loop
x0 <- data.frame()
for (f in files) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
View(x)
con.text <- "DRIVER=SQL Server Native Client 11.0;Database=testing;Server=UWCO-BGILLISLT;Port=1433;UID=bgillis;PWD=sweetness4"
con <- con <- odbcDriverConnect(con.text)
d <- read_csv(paste0(dir,f))
names(d)[1] <- "agency"
names(d)[2] <- "program"
d$row_id <- row.names(d)
tool <- tolower(substr(names(d)[[3]],1,regexpr(":",names(d)[[3]])-1))
dl <- melt(d, id.vars= c("agency","program","row_id"))
dl$variable <- as.character(dl$variable)
dl$tool <- rep(tool, length(dl$agency))
dl$submission <- rep(f, length(dl$agency))
tci <- sqlQuery(con,  paste0("select * from tool_column_info where tool = '",tool,"'"),
stringsAsFactors =F)
x0 <- data.frame()
for (f in files) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
d <- read_csv(paste0(dir,f))
# change a couple of the columns around
names(d)[1] <- "agency"
names(d)[2] <- "program"
d$row_id <- row.names(d)
tool <- tolower(substr(names(d)[[3]],1,regexpr(":",names(d)[[3]])-1))
dl <- melt(d, id.vars= c("agency","program","row_id"))
dl$variable <- as.character(dl$variable)
dl$tool <- rep(tool, length(dl$agency))
dl$submission <- rep(f, length(dl$agency))
x <- dl %>%
left_join(tci, by = c("variable" = "csv_header" )) %>%
select(
submission,
row_id,
col_num,
agency,
program,
display_name,
value
)
x0 <- data.frame()
for (f in files) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
x0 <- data.frame()
for (f in files) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
x0 <- data.frame()
for (f in files) {
x = load_cld(dir, f)
x0 <- rbind(x0, x)
}
con.text <- "DRIVER=SQL Server Native Client 11.0;Database=testing;Server=UWCO-BGILLISLT;Port=1433;UID=bgillis;PWD=sweetness4"
con <- con <- odbcDriverConnect(con.text)
d <- read_csv(paste0(dir,f))
# change a couple of the columns around
names(d)[1] <- "agency"
names(d)[2] <- "program"
d$row_id <- row.names(d)
# get the tool number (tool)
tool <- tolower(substr(names(d)[[3]],1,regexpr(":",names(d)[[3]])-1))
dl <- melt(d, id.vars= c("agency","program","row_id"))
dl$variable <- as.character(dl$variable)
dl$tool <- rep(tool, length(dl$agency))
dl$submission <- rep(f, length(dl$agency))
View(x0)
table(x0$submission)
x = load_cld(dir, f)
files
y = load_cld(dir, f)
dir <- "C:/Users/bgillis/Desktop/CSVs provided by Agencies/"
f <- files[1]
files <- list.files(dir)
f <- files[1]
load_cld <- function(dir, f) {
library(RODBC)
library(reshape2)
library(dplyr)
con.text <- "DRIVER=SQL Server Native Client 11.0;Database=testing;Server=UWCO-BGILLISLT;Port=1433;UID=bgillis;PWD=sweetness4"
con <- con <- odbcDriverConnect(con.text)
d <- read_csv(paste0(dir,f))
# change a couple of the columns around
names(d)[1] <- "agency"
names(d)[2] <- "program"
d$row_id <- row.names(d)
# get the tool number (tool)
tool <- tolower(substr(names(d)[[3]],1,regexpr(":",names(d)[[3]])-1))
# melt
dl <- melt(d, id.vars= c("agency","program","row_id"))
dl$variable <- as.character(dl$variable)
dl$tool <- rep(tool, length(dl$agency))
dl$submission <- rep(f, length(dl$agency))
# maybe this should just be used to pull in the names?
# import the appropriate fields
#tci <- sqlQuery(con,  paste0("select * from tool_column_info where tool = '",tool,"'"),
#stringsAsFactors =F)
# x <- dl %>%
#   left_join(tci, by = c("variable" = "csv_header" )) %>%
#   select(
#     submission,
#     row_id,
#     col_num,
#     agency,
#     program,
#     display_name,
#     value
#   )
# get client id by row and submission (Cid)
#   I will need to go back in and do this
return(dl)
}
load_cld(dir, f)
y <- load_cld(dir, f)
f <- files[2]
y <- load_cld(dir, f)
for (f in files) {
y = load_cld(dir, f)
x0 <- rbind(x0, y)
}
x0 <- data.frame()
for (f in files) {
y = load_cld(dir, f)
x0 <- rbind(x0, y)
}
sqlQuery(con, "Drop Table if Exists client_level_data_staging")
sqlSave(con, x0, "client_level_data_staging", rownames = F)
con.text <- "DRIVER=SQL Server Native Client 11.0;Database=testing;Server=UWCO-BGILLISLT;Port=1433;UID=bgillis;PWD=sweetness4"
con <- con <- odbcDriverConnect(con.text)
sqlQuery(con, "Drop Table if Exists client_level_data_staging")
sqlSave(con, x0, "client_level_data_staging", rownames = F)
library(RODBC)
library(reshape2)
library(dplyr)
con.text <- "DRIVER=SQL Server Native Client 11.0;Database=testing;Server=UWCO-BGILLISLT;Port=1433;UID=bgillis;PWD=sweetness4"
con <- con <- odbcDriverConnect(con.text)
d <- read_csv(paste0(dir,f))
# change a couple of the columns around
names(d)[1] <- "agency"
names(d)[2] <- "program"
d$row_id <- row.names(d)
dir <- "C:/Users/bgillis/Desktop/CSVs provided by Agencies/"
files <- list.files(dir)
f <- files[1]
d <- read_csv(paste0(dir,f))
names(d)[1] <- "agency"
names(d)[2] <- "program"
d$row_id <- row.names(d)
ap.id <- sqlFetch(con, "agency_program_id")
names(ap.id) <- tolower(names(ap.id))
adist('brian', 'zzzzbrian')
adist('brian', 'brain')
ap.id <- sqlFetch(con, "agency_program_id", stringsAsFactors =F)
names(ap.id) <- tolower(names(ap.id)) # set up names so I don't need to do this
dist.test <- adist(paste(ap.id$agency, ap.id$program), paste(d$agency, d$program))
View(dist.test)
dist.test <- adist(paste(ap.id$agency, ap.id$program), paste(d[1]$agency, d[1]$program))
dist.test <- adist(paste(ap.id$agency, ap.id$program), paste(d[1]$agency, d[[1]]$program))
dist.test <- adist(paste(ap.id$agency, ap.id$program), paste(d[1]$agency, d[1]$program))
dist.test <- adist(paste(ap.id$agency, ap.id$program), paste(d[1,]$agency, d[1,]$program))
View(dist.test)
max(dist.test)
dist.test[V1==max(dist.test)]
View(dist.test)
dist.test[dist.test$V1==max(dist.test)]
dist.test[dist.test==max(dist.test)]
row.name(dist.test[dist.test==max(dist.test)])
View(dist.test)
row.names(dist.test[dist.test==max(dist.test)])
row.names(dist.test[dist.test==max(dist.test)])
grep(max(dist.test),dis.test)
grep(max(dist.test),dist.test)
ap.id[38,]
grep(min(dist.test),dist.test)
grep(min(dist.test),dist.test)
View(dist.test)
View(dist.test)
min(dist.test)
grep(min(dist.test),dist.test)
View(dist.test)
grep(min(dist.test),dist.test, fixed=T)
dist.test[min(dist.test)]
dist.test[dist.test == min(dist.test)]
dist.test[dist.test == min(dist.test)]
which(dist.test == min(dist.test))
ap.id[which(dist.test == min(dist.test)),]
d$ap_id <- rep(ap.id[which(dist.test == min(dist.test)),],length(d$agency))
ap_id <- ap.id[which(dist.test == min(dist.test)),]
d$ap_id <- rep(ap.id[which(dist.test == min(dist.test)),3],length(d$agency))
dl <- melt(d, id.vars= c("ap_id", "agency","program","row_id"))
dl$variable <- as.character(dl$variable)
dl$tool <- rep(tool, length(dl$agency))
dl$submission <- rep(f, length(dl$agency))
tool <- tolower(substr(names(d)[[3]],1,regexpr(":",names(d)[[3]])-1))
dl <- melt(d, id.vars= c("ap_id", "agency","program","row_id"))
dl$variable <- as.character(dl$variable)
dl$tool <- rep(tool, length(dl$agency))
dl$submission <- rep(f, length(dl$agency))
